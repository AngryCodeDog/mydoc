应该可以通过外部指定视频流给主机识别，通过test_ws.py这个文件就可以测试。





---



## 方案：可以通过ffmpeg实现监控摄像头的RTSP协议转RTMP协议直播

### 1、首先安装nginx，nginx-rtmp-module

参考：https://www.jianshu.com/p/93c5a418426e

### 2、 配置nginx

安装完之后配置nginx，`sudo vim /usr/local/nginx/conf/nginx.conf`在配置文件最后添加

```shell
rtmp {
    server {
        listen 1935;  #监听的端口

        chunk_size 4000;

       application live {
               live on;
               record off;
               # 可以使用类似下面的语句转换视频格式为新的视频播放源
               #exec ffmpeg -i rtmp://localhost/live/$name -threads 1 -c:v libx264 -profile:v baseline -b:v 350K -s 640x360 -f flv -c:a aac -ac 1 -strict -2 -b:a 56k rtmp://localhost/livep/$name;
       }
       application livep {
               live on;
               record off;
       }

       # application hls {  #rtmp推流请求路径  
       #     live on;
       #     hls on;
       #     hls_path /usr/local/nginx/html/hls;
       #     hls_fragment 5s;
       #  }    
    }    
}
```

配置完了后，我们先干掉nginx

`pkill -9 nginx`

再启动nginx，加载配置：

`/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf`

接着我们便可以查看一下端口监听

```shell
zyp@zyp-work:~$ netstat -ntlp
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:63342         0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:1935            0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:5939          0.0.0.0:*               LISTEN     
tcp        0      0 127.0.1.1:53            0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:6942          0.0.0.0:*               LISTEN     
tcp6       0      0 ::1:631                 :::*                    LISTEN     
```

我们可以看到1935端口在被监听；

然后浏览器输入localhost，看是否能成功进入nginx的欢迎页面；

如果成功，我们便可以进行下一步了。

### 3、安装FFmpeg

还没安装FFmpeg的，这就赶紧安装吧：

```
sudo apt-add-repository ppa:jon-severinsson/ffmpeg
sudo apt-get update
sudo apt-get install ffmpeg
```

### 4 、 开始推流

使用命令：

```
ffmpeg -i 'rtsp://192.168.1.10/user=admin&password=&channel=1&stream=0,sdp' -vcodec copy -acodec aac -f flv 'rtmp://127.0.0.1:1936/live/test1'
```

解释：

```shell
ffmpeg -i 'your rtsp url' -vcodes copy -acodes aac -f flv 'your rtmp url'
```

输入你的**rtsp url**，你的**rtmp url**（这个url就是前面配置nginx的rtmp server的地址），我们在后面加了个test1地址，你不加也没关系。

我们还可以输出一些bug信息：

```
ffmpeg -loglevel debug -i 'rtsp://192.168.1.10/user=admin&password=&channel=1&stream=0,sdp' -vcodec copy -acodec aac -f flv 'rtmp://127.0.0.1:1936/live/test1'
```

这样你启动成功后，你就可以看到一直在推送视频流信息到服务器上去。

然后我们直接用vlc播放器，添加一个网络播放地址：rtmp://127.0.0.1:1936/live/test1

就可以直接看到视频流的信息了。

### 5、网页显示

试了2次，貌似网页可能要支持rtmp还是有点难的。

可能要hls方式来播放了。

坑爹啊，唉。



```shell
#!/bin/bash
 
SERVICE="ffmpeg"
RTSP_URL="rtsp地址"
RTMP_URL="rtmp地址"
 
COMMAND="sudo ffmpeg -rtsp_transport tcp -i ${RTSP_URL} -vcodec copy -an -f flv ${RTMP_URL}"
 
if sudo /usr/bin/pgrep $SERVICE > /dev/null
then
        echo "${SERVICE} is already running."
else
        echo "${SERVICE} is NOT running! Starting now..."
        $COMMAND
fi
```

一个ffmpeg的rtsp转rtmp的shell脚本

---



网页和box通过websocket建立一个长连接，并且传递一个视频流的url给box，然后box会返回对应的识别消息。



那么html的视频显示是怎么回事？

android的app加载网页，然后js通过调用android本地的视频播放来进行视频的播放。

```javascript
window.KCAndroid.playVideo(KCScreen.videoSource, left, top, width, height);
```

android本地采用vlc这个库进行rtsp视频流的播放。



接口：

- [x] /auth/login
- [ ] /auth/logout
- [ ] /auth/reset
- [ ] /auth/change-password
- [ ] /overview/statistics?size=10&_=1524197580595   今日员工记录，今日访客记录，今日警告记录
- [ ] /system/screen?size=10&_=1524197580596      当前用户绑定的门禁设备
- [x] /subject/list?category=employee&size=10&_=1524197936792       员工列表
- [x] /subject/list?category=visitor&size=10&_=1524198280883    访客列表
- [ ] /subject           新增员工，访客
- [ ] /subject/subject_id                **get,delete,put** 员工修改，删除
- [ ] /subject/avatar                    显示头像
- [ ] /subject/photo                    识别照片
- [x] /event/events?category=user&start=&user_role=&size=10&_=1524198652468
- [x] /event/events?category=warning&start=&user_role=&size=10&_=1524198695471
- [ ] /system/attendance/setting?_=1524198896963        **put,get,** 门禁设置
- [ ] `/system/attendance/calendar/<int:year1>`        **put, get**  日历设置
- [ ] /system/display-device?size=10&_=1524206738367   
- [ ] `/system/display-device/<int:device_id>`  **get,put,delete** 主题设置
- [ ] /system/theme      获取主题列表
- [ ] /system/account/list    帐号管理列表

还有些接口没有写上来，也就是说至少还有15个以上的接口未完成，每天3个也需要一周，那这样就估计完全搞完得需要2周了。